---
title: Java多线程之锁
date: 2018-01-12 11:30:12
tages:
- 多线程
categories: 
- Java
- 多线程
---

# 悲观锁与乐观锁

线程要不要锁住同步资源？

- 锁住：悲观锁
- 不锁住：乐观锁

## 悲观锁

### 概念

对于同一数据的并发操作，悲观锁认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改。Java中，synchronized关键字和Lock接口的实现都是悲观锁。

#### 使用场景

悲观锁适合写操作多的场景，先加锁可以保证写操作时数据正确。

## 乐观锁

### 概念

使用数据时会认为不会有别的线程修改数据，所以不会添加锁，只是在更新数据的时候去判断之前有没有别的线程更新了这个数据。如果这个数据没有被更新，当前线程将自己修改的数据成功写入。如果数据已经被其他线程更新，则根据不同的实现方式执行不同的操作（例如报错或者自动重试）。在Java中，最常用的是CAS算法，Java原子类中的递增操作就通过CAS自旋实现的。

### 使用场景

乐观锁适合读操作多的场景，不加锁的特点能够使其读操作的性能大幅提升。

### CAS算法

#### 三个操作数

- 需要读写的内存值V
- 进行比较的值A
- 要写入的值B

#### 实现过程

当且仅当 V 的值等于 A 时，CAS通过原子方式用新值B来更新V的值（“比较+更新”整体是一个原子操作），否则不会执行任何操作。一般情况下，“更新”是一个不断重试的操作。

#### JDK实现

#### 存在的问题